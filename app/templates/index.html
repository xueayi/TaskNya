<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskNya - 通用任务监控工具</title>
    <!-- 引入Bootstrap CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Bootstrap Icons -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- 引入自定义主题CSS -->
    <link href="{{ url_for('static', filename='css/themes.css') }}" rel="stylesheet">
    <!-- 引入自定义样式CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <!-- 预载入字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container mt-4">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">
                <i class="bi bi-phone-vibrate"></i> TaskNya
                <small class="d-block fs-6 text-muted">通用任务监控工具</small>
            </h1>

            <div class="d-flex align-items-center">
                <span id="statusBadge" class="badge bg-secondary me-3">
                    <i class="bi bi-circle-fill me-1"></i> 未开始
                </span>
            </div>
        </header>

        <!-- 主操作区和日志区 -->
        <div class="row mb-4">
            <!-- 控制面板 -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h3><i class="bi bi-joystick"></i> 控制面板</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-3">
                            <button id="startBtn" class="btn btn-lg btn-success" onclick="startMonitor()">
                                <i class="bi bi-play-fill"></i> 开始检测
                            </button>
                            <button id="stopBtn" class="btn btn-lg btn-danger" onclick="stopMonitor()" disabled>
                                <i class="bi bi-stop-fill"></i> 停止检测
                            </button>
                            <div class="d-flex justify-content-between mt-2">
                                <button class="btn btn-success flex-grow-1 me-2" onclick="saveConfig()">
                                    <i class="bi bi-save"></i> 保存配置
                                </button>
                                <button class="btn btn-secondary flex-grow-1" onclick="loadConfigList()">
                                    <i class="bi bi-folder2-open"></i> 加载配置
                                </button>
                            </div>
                            <button class="btn btn-primary" id="applyConfigBtn" onclick="applyCurrentConfig()">
                                <i class="bi bi-check-circle"></i> 应用配置
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 日志看板 -->
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="bi bi-terminal"></i> 运行日志</h3>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> 清空日志
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="logPanel" class="p-3 rounded">
                            <!-- 日志内容将动态添加到这里 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 配置区 -->
        <div class="card mb-4">
            <div class="card-header">
                <h3><i class="bi bi-gear"></i> 配置管理</h3>
            </div>
            <div class="card-body">
                <!-- 配置导航标签 -->
                <ul class="nav nav-tabs mb-3" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general"
                            type="button" role="tab" aria-controls="general" aria-selected="true">
                            <i class="bi bi-sliders"></i> 基本设置
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="detection-tab" data-bs-toggle="tab" data-bs-target="#detection"
                            type="button" role="tab" aria-controls="detection" aria-selected="false">
                            <i class="bi bi-search"></i> 检测方法
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notification-tab" data-bs-toggle="tab"
                            data-bs-target="#notification" type="button" role="tab" aria-controls="notification"
                            aria-selected="false">
                            <i class="bi bi-bell"></i> 通知设置
                        </button>
                    </li>
                </ul>

                <!-- 配置表单 -->
                <form id="configForm">
                    <div class="tab-content" id="configTabsContent">
                        <!-- 基本配置选项卡 -->
                        <div class="tab-pane fade show active" id="general" role="tabpanel"
                            aria-labelledby="general-tab">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-sliders"></i> 基本设置</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">项目名称</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-braces"></i></span>
                                                    <input type="text" class="form-control" name="monitor.project_name"
                                                        value="{{ config.monitor.project_name }}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">检查间隔</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                                    <input type="text" class="form-control"
                                                        name="monitor.check_interval"
                                                        value="{{ config.monitor.check_interval }}"
                                                        placeholder="例如: 60 或 1h30m">
                                                </div>
                                                <div class="form-text">支持秒数或时分格式（如
                                                    <code>90</code>、<code>1h30m</code>、<code>30m5s</code>）
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">日志打印间隔</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-printer"></i></span>
                                                    <input type="text" class="form-control" name="monitor.logprint"
                                                        value="{{ config.monitor.logprint }}" placeholder="例如: 60 或 5m">
                                                </div>
                                                <div class="form-text">支持秒数或时分格式（如
                                                    <code>60</code>、<code>5m</code>、<code>1h</code>）
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">监控持续时间</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i
                                                            class="bi bi-hourglass-split"></i></span>
                                                    <input type="text" class="form-control" name="monitor.timeout"
                                                        value="{{ config.monitor.timeout or 'None' }}"
                                                        placeholder="None 或 1h">
                                                </div>
                                                <div class="form-text">设置为 <code>None</code> 表示无超时限制，支持时分格式</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 检测方法选项卡 -->
                        <div class="tab-pane fade" id="detection" role="tabpanel" aria-labelledby="detection-tab">
                            <!-- 单文件感知配置 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="file_check_switch"
                                            name="monitor.check_file_enabled" {% if config.monitor.check_file_enabled
                                            %}checked{% endif %}>
                                        <label class="form-check-label" for="file_check_switch">
                                            <i class="bi bi-file-earmark-check"></i> 单文件感知
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">检查文件路径</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-folder2"></i></span>
                                            <input type="text" class="form-control" name="monitor.check_file_path"
                                                value="{{ config.monitor.check_file_path }}">
                                        </div>
                                        <div class="form-text">
                                            <strong>路径填写说明：</strong><br>
                                            · <strong>Windows：</strong> <code>D:\outputs\model.pth</code> 或
                                            <code>.\output\result.txt</code><br>
                                            · <strong>Linux/Mac：</strong> <code>/home/user/training/model.pth</code> 或
                                            <code>./output/result.txt</code><br>
                                            · <strong>Docker容器：</strong> <code>/app/monitor_targets/目标文件名</code>（需在
                                            docker-compose.yml 中挂载卷）
                                        </div>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="file_deletion_switch"
                                            name="monitor.check_file_detect_deletion" {% if
                                            config.monitor.check_file_detect_deletion %}checked{% endif %}>
                                        <label class="form-check-label" for="file_deletion_switch">
                                            <i class="bi bi-trash"></i> 检测文件删除（文件从存在变为不存在时触发通知）
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 日志检查配置 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="log_check_switch"
                                            name="monitor.check_log_enabled" {% if config.monitor.check_log_enabled
                                            %}checked{% endif %}>
                                        <label class="form-check-label" for="log_check_switch">
                                            <i class="bi bi-journal-text"></i> 日志检查
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">日志文件路径</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-file-text"></i></span>
                                            <input type="text" class="form-control" name="monitor.check_log_path"
                                                value="{{ config.monitor.check_log_path }}">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">检测模式</label>
                                        <select class="form-select" name="monitor.check_log_mode">
                                            <option value="full" {% if config.monitor.check_log_mode=='full'
                                                %}selected{% endif %}>全量检测 - 每次检查整个文件</option>
                                            <option value="incremental" {% if
                                                config.monitor.check_log_mode=='incremental' %}selected{% endif %}>增量检测
                                                - 只检查新增内容</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">触发关键词（每行一个）</label>
                                        <textarea class="form-control" name="monitor.check_log_markers" rows="3"
                                            placeholder="例如: Training completed, 训练完成">{{ '\n'.join(config.monitor.check_log_markers) }}</textarea>
                                        <div class="form-text">当日志中出现这些文本时，认为任务已完成</div>
                                    </div>
                                </div>
                            </div>

                            <!-- GPU功耗检查配置 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="gpu_check_switch"
                                            name="monitor.check_gpu_power_enabled" {% if
                                            config.monitor.check_gpu_power_enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="gpu_check_switch">
                                            <i class="bi bi-gpu-card"></i> GPU功耗检查
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">触发模式</label>
                                                <select class="form-select" name="monitor.check_gpu_power_trigger_mode"
                                                    id="gpu_trigger_mode_select">
                                                    <option value="below" {% if
                                                        config.monitor.check_gpu_power_trigger_mode=='below' or not
                                                        config.monitor.check_gpu_power_trigger_mode %}selected{% endif
                                                        %}>低于阈值触发</option>
                                                    <option value="above" {% if
                                                        config.monitor.check_gpu_power_trigger_mode=='above'
                                                        %}selected{% endif %}>高于阈值触发</option>
                                                </select>
                                                <div class="form-text" id="gpu_mode_hint">适用于训练完成后功耗下降的情况</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">功耗阈值(瓦特)</label>
                                                <div class="input-group">
                                                    <input type="number" step="0.1" class="form-control"
                                                        name="monitor.check_gpu_power_threshold"
                                                        value="{{ config.monitor.check_gpu_power_threshold }}">
                                                    <span class="input-group-text">W</span>
                                                </div>
                                                <div class="form-text">需安装 nvidia-smi</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">GPU ID</label>
                                                <input type="text" class="form-control"
                                                    name="monitor.check_gpu_power_gpu_ids"
                                                    value="{{ config.monitor.check_gpu_power_gpu_ids }}">
                                                <div class="form-text">"all" 或 "0,1"</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">连续检测次数</label>
                                                <input type="number" class="form-control"
                                                    name="monitor.check_gpu_power_consecutive_checks"
                                                    value="{{ config.monitor.check_gpu_power_consecutive_checks }}">
                                                <div class="form-text" id="gpu_consecutive_hint">连续达到阈值后触发</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 多文件感知（目录监控）配置 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="directory_check_switch"
                                            name="monitor.check_directory_enabled" {% if
                                            config.monitor.check_directory_enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="directory_check_switch">
                                            <i class="bi bi-folder2-open"></i> 多文件感知（目录监控）
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">监控目录路径</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-folder"></i></span>
                                            <input type="text" class="form-control" name="monitor.check_directory_path"
                                                value="{{ config.monitor.check_directory_path }}"
                                                placeholder="例如: /data/models 或 D:\outputs">
                                        </div>
                                        <div class="form-text">
                                            <strong>路径填写说明：</strong><br>
                                            · Windows: <code>D:\outputs\models</code> 或 <code>.\relative\path</code><br>
                                            · Linux/Mac: <code>/data/models</code> 或 <code>./relative/path</code><br>
                                            · Docker容器: <code>/app/monitor_targets</code>（需挂载卷）
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input type="checkbox" class="form-check-input" id="detect_added_switch"
                                                    name="monitor.check_directory_detect_added" {% if
                                                    config.monitor.check_directory_detect_added %}checked{% endif %}>
                                                <label class="form-check-label" for="detect_added_switch">
                                                    检测文件新增</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input type="checkbox" class="form-check-input"
                                                    id="detect_removed_switch"
                                                    name="monitor.check_directory_detect_removed" {% if
                                                    config.monitor.check_directory_detect_removed %}checked{% endif %}>
                                                <label class="form-check-label" for="detect_removed_switch">
                                                    检测文件删除</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input type="checkbox" class="form-check-input"
                                                    id="detect_modified_switch"
                                                    name="monitor.check_directory_detect_modified" {% if
                                                    config.monitor.check_directory_detect_modified %}checked{% endif %}>
                                                <label class="form-check-label" for="detect_modified_switch">
                                                    检测文件修改</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <div class="form-check form-switch pt-2">
                                                    <input type="checkbox" class="form-check-input"
                                                        id="include_folders_switch"
                                                        name="monitor.check_directory_include_folders" {% if
                                                        config.monitor.check_directory_include_folders %}checked{% endif
                                                        %}>
                                                    <label class="form-check-label" for="include_folders_switch">
                                                        检测文件夹变化
                                                    </label>
                                                </div>
                                                <div class="form-check form-switch pt-2">
                                                    <input type="checkbox" class="form-check-input"
                                                        id="continuous_mode_switch"
                                                        name="monitor.check_directory_continuous_mode" {% if
                                                        config.monitor.check_directory_continuous_mode %}checked{% endif
                                                        %}>
                                                    <label class="form-check-label" for="continuous_mode_switch">
                                                        <i class="bi bi-arrow-repeat"></i> 持续监控模式
                                                    </label>
                                                    <div class="form-text">触发通知后继续运行，持续捕获变化</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">二次确认延迟（秒）</label>
                                                <input type="number" class="form-control"
                                                    name="monitor.check_directory_recheck_delay"
                                                    value="{{ config.monitor.check_directory_recheck_delay }}" min="0">
                                                <div class="form-text">检测到变化后等待N秒再次确认</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">报告保存路径</label>
                                                <input type="text" class="form-control"
                                                    name="monitor.check_directory_report_path"
                                                    value="{{ config.monitor.check_directory_report_path or '' }}"
                                                    placeholder="留空则保存到监控目录">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">排除关键词（每行一个）</label>
                                        <textarea class="form-control" name="monitor.check_directory_exclude_keywords"
                                            rows="2"
                                            placeholder="例如: __pycache__, .git, .tmp">{{ '\n'.join(config.monitor.check_directory_exclude_keywords) if config.monitor.check_directory_exclude_keywords else '' }}</textarea>
                                        <div class="form-text">包含这些关键词的路径将被忽略</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">操作建议配置</label>
                                        <textarea class="form-control" id="action_keywords_input"
                                            name="monitor.check_directory_action_keywords_text" rows="4"
                                            placeholder="每行一组，格式：建议内容: 关键词1, 关键词2"></textarea>
                                        <div class="form-text">
                                            <strong>格式说明：</strong>每行定义一个操作建议规则<br>
                                            <strong>格式：</strong><code>建议内容: 关键词1, 关键词2, ...</code>（冒号分隔建议与关键词，逗号分隔多个关键词）<br>
                                            <strong>示例：</strong><br>
                                            <code>备份: important, backup</code> → 文件名含 important 或 backup 时建议"备份"<br>
                                            <code>清理: .tmp, .cache, temp</code> → 文件名含 .tmp/.cache/temp 时建议"清理"
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 通知设置选项卡 -->
                        <div class="tab-pane fade" id="notification" role="tabpanel" aria-labelledby="notification-tab">
                            <!-- Webhook配置 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="webhook_switch"
                                            name="webhook.enabled" {% if config.webhook.enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="webhook_switch">
                                            <i class="bi bi-bell"></i> 飞书机器人通知
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Webhook URL</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                                            <input type="text" class="form-control" name="webhook.url"
                                                value="{{ config.webhook.url }}">
                                        </div>
                                        <div class="form-text">飞书机器人配置详见<a
                                                href="https://open.feishu.cn/document/client-docs/bot-v3/add-custom-bot"
                                                target="_blank">官方文档</a></div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">消息标题</label>
                                                <input type="text" class="form-control" name="webhook.title"
                                                    value="{{ config.webhook.title }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">卡片颜色</label>
                                                <select class="form-select" name="webhook.color">
                                                    <option value="green" {% if config.webhook.color=='green'
                                                        %}selected{% endif %}>绿色</option>
                                                    <option value="blue" {% if config.webhook.color=='blue' %}selected{%
                                                        endif %}>蓝色</option>
                                                    <option value="red" {% if config.webhook.color=='red' %}selected{%
                                                        endif %}>红色</option>
                                                    <option value="grey" {% if config.webhook.color=='grey' %}selected{%
                                                        endif %}>灰色</option>
                                                    <option value="turquoise" {% if config.webhook.color=='turquoise'
                                                        %}selected{% endif %}>青色</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">页脚信息</label>
                                        <input type="text" class="form-control" name="webhook.footer"
                                            value="{{ config.webhook.footer }}">
                                    </div>

                                    <h5 class="mt-4 mb-3">通知内容设置</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" class="form-check-input"
                                                        id="include_project_name" name="webhook.include_project_name" {%
                                                        if config.webhook.include_project_name %}checked{% endif %}>
                                                    <label class="form-check-label"
                                                        for="include_project_name">包含项目名称</label>
                                                </div>
                                                <input type="text" class="form-control mt-2"
                                                    name="webhook.include_project_name_title"
                                                    value="{{ config.webhook.include_project_name_title }}"
                                                    placeholder="标题">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" class="form-check-input"
                                                        id="include_start_time" name="webhook.include_start_time" {% if
                                                        config.webhook.include_start_time %}checked{% endif %}>
                                                    <label class="form-check-label"
                                                        for="include_start_time">包含开始时间</label>
                                                </div>
                                                <input type="text" class="form-control mt-2"
                                                    name="webhook.include_start_time_title"
                                                    value="{{ config.webhook.include_start_time_title }}"
                                                    placeholder="标题">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" class="form-check-input"
                                                        id="include_end_time" name="webhook.include_end_time" {% if
                                                        config.webhook.include_end_time %}checked{% endif %}>
                                                    <label class="form-check-label"
                                                        for="include_end_time">包含结束时间</label>
                                                </div>
                                                <input type="text" class="form-control mt-2"
                                                    name="webhook.include_end_time_title"
                                                    value="{{ config.webhook.include_end_time_title }}"
                                                    placeholder="标题">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" class="form-check-input" id="include_method"
                                                        name="webhook.include_method" {% if
                                                        config.webhook.include_method %}checked{% endif %}>
                                                    <label class="form-check-label" for="include_method">包含判断方法</label>
                                                </div>
                                                <input type="text" class="form-control mt-2"
                                                    name="webhook.include_method_title"
                                                    value="{{ config.webhook.include_method_title }}" placeholder="标题">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" class="form-check-input"
                                                        id="include_duration" name="webhook.include_duration" {% if
                                                        config.webhook.include_duration %}checked{% endif %}>
                                                    <label class="form-check-label"
                                                        for="include_duration">包含任务时长</label>
                                                </div>
                                                <input type="text" class="form-control mt-2"
                                                    name="webhook.include_duration_title"
                                                    value="{{ config.webhook.include_duration_title }}"
                                                    placeholder="标题">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" class="form-check-input"
                                                        id="include_hostname" name="webhook.include_hostname" {% if
                                                        config.webhook.include_hostname %}checked{% endif %}>
                                                    <label class="form-check-label" for="include_hostname">包含主机名</label>
                                                </div>
                                                <input type="text" class="form-control mt-2"
                                                    name="webhook.include_hostname_title"
                                                    value="{{ config.webhook.include_hostname_title }}"
                                                    placeholder="标题">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" class="form-check-input"
                                                        id="include_gpu_info" name="webhook.include_gpu_info" {% if
                                                        config.webhook.include_gpu_info %}checked{% endif %}>
                                                    <label class="form-check-label"
                                                        for="include_gpu_info">包含GPU信息</label>
                                                </div>
                                                <input type="text" class="form-control mt-2"
                                                    name="webhook.include_gpu_info_title"
                                                    value="{{ config.webhook.include_gpu_info_title }}"
                                                    placeholder="标题">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 通用 Webhook 配置 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="generic_webhook_switch"
                                            name="generic_webhook.enabled" {% if config.generic_webhook.enabled
                                            %}checked{% endif %}>
                                        <label class="form-check-label" for="generic_webhook_switch">
                                            <i class="bi bi-link-45deg"></i> 通用 Webhook
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Webhook URL</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-link"></i></span>
                                                    <input type="text" class="form-control" name="generic_webhook.url"
                                                        value="{{ config.generic_webhook.url }}"
                                                        placeholder="https://...">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">HTTP 方法</label>
                                                <select class="form-select" name="generic_webhook.method">
                                                    <option value="POST" {% if config.generic_webhook.method=='POST'
                                                        %}selected{% endif %}>POST</option>
                                                    <option value="PUT" {% if config.generic_webhook.method=='PUT'
                                                        %}selected{% endif %}>PUT</option>
                                                    <option value="GET" {% if config.generic_webhook.method=='GET'
                                                        %}selected{% endif %}>GET</option>
                                                    <option value="DELETE" {% if config.generic_webhook.method=='DELETE'
                                                        %}selected{% endif %}>DELETE</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">重试次数</label>
                                                <select class="form-select" name="generic_webhook.retry_count">
                                                    <option value="0" {% if config.generic_webhook.retry_count==0
                                                        %}selected{% endif %}>不重试</option>
                                                    <option value="1" {% if config.generic_webhook.retry_count==1
                                                        %}selected{% endif %}>1 次</option>
                                                    <option value="2" {% if config.generic_webhook.retry_count==2
                                                        %}selected{% endif %}>2 次</option>
                                                    <option value="3" {% if config.generic_webhook.retry_count==3
                                                        %}selected{% endif %}>3 次</option>
                                                    <option value="5" {% if config.generic_webhook.retry_count==5
                                                        %}selected{% endif %}>5 次</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 自定义模式 -->
                                    <div class="mb-3" id="custom_body_section">
                                        <label class="form-label">请求头 (JSON)</label>
                                        <textarea class="form-control" name="generic_webhook.headers" rows="2"
                                            placeholder='{"Content-Type": "application/json"}'>{{ config.generic_webhook.headers | tojson if config.generic_webhook.headers else '{"Content-Type": "application/json"}' }}</textarea>
                                    </div>


                                    <div class="mb-3">
                                        <label class="form-label">自定义 Body (JSON)</label>
                                        <textarea class="form-control" name="generic_webhook.body" rows="4"
                                            placeholder='{"content": "项目 ${project_name} 已完成，耗时 ${duration}"}'>{{ config.generic_webhook.body }}</textarea>
                                        <div class="form-text">
                                            <strong>可用变量说明:</strong><br>
                                            <code>${project_name}</code> - 项目名称<br>
                                            <code>${start_time}</code> - 开始时间 (格式: YYYY-MM-DD HH:MM:SS)<br>
                                            <code>${end_time}</code> - 结束时间<br>
                                            <code>${duration}</code> - 总耗时 (格式: H:MM:SS)<br>
                                            <code>${method}</code> - 触发方式 (如: 目标文件检测, GPU功耗检测)<br>
                                            <code>${hostname}</code> - 主机名<br>
                                            <code>${gpu_info}</code> - GPU 信息<br>
                                            <code>${detail}</code> - 触发详情 (多文件感知时为报告摘要)<br>
                                            <code>${report_summary}</code> - 目录报告统计摘要<br>
                                            <code>${report_change_list}</code> - 增加及删除的文件列表<br>
                                            <code>${report_actions}</code> - 建议操作汇总<br>
                                            <code>${anime_quote}</code> - 二次元语录 (需开启)
                                        </div>
                                    </div>

                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="anime_quote_switch"
                                            name="generic_webhook.anime_quote_enabled" {% if
                                            config.generic_webhook.anime_quote_enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="anime_quote_switch">
                                            <i class="bi bi-chat-quote"></i> 追加二次元语录
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <footer class="text-center text-muted mb-4">
                <p>TaskNya - 通用任务监控工具 v0.5.0-test</p>
                <p>
                    <a href="https://github.com/xueayi/TaskNya/" target="_blank" class="text-decoration-none">
                        <i class="bi bi-github"></i> GitHub 项目页
                    </a>
                    <span style="margin: 0 10px;">|</span>
                    <a href="https://open.feishu.cn/document/client-docs/bot-v3/add-custom-bot" target="_blank"
                        class="text-decoration-none">
                        <i class="bi bi-book"></i> 飞书机器人配置文档
                    </a>
                </p>
            </footer>
        </div>

        <!-- 保存配置模态框 -->
        <div class="modal fade" id="saveConfigModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">保存配置</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">配置名称</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-tag"></i></span>
                                <input type="text" class="form-control" id="configName" placeholder="请输入配置名称">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveConfigWithName()">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 配置列表模态框 -->
        <div class="modal fade" id="configListModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">已保存的配置</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="list-group" id="configList"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- JavaScript -->
        <script>
            const INITIAL_ACTION_KEYWORDS = {{ config.monitor.check_directory_action_keywords | tojson }};

            // 初始化操作建议文本框
            document.addEventListener('DOMContentLoaded', function () {
                const textarea = document.getElementById('action_keywords_input');
                if (textarea && INITIAL_ACTION_KEYWORDS) {
                    const lines = [];
                    for (const [action, keywords] of Object.entries(INITIAL_ACTION_KEYWORDS)) {
                        const keywordStr = Array.isArray(keywords) ? keywords.join(', ') : keywords;
                        lines.push(`${action}: ${keywordStr}`);
                    }
                    textarea.value = lines.join('\n');
                }
            });
        </script>
        <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
        <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
        <script src="{{ url_for('static', filename='js/main.js') }}"></script>
        <script>
            // 更新状态徽章
            function updateStatusBadge(status) {
                const badge = document.getElementById('statusBadge');
                if (status === 'running') {
                    badge.className = 'badge bg-success me-3';
                    badge.innerHTML = '<i class="bi bi-circle-fill me-1"></i> 监控中';
                } else if (status === 'stopped') {
                    badge.className = 'badge bg-secondary me-3';
                    badge.innerHTML = '<i class="bi bi-circle-fill me-1"></i> 已停止';
                }
            }

            // 重写updateMonitorStatus函数
            function updateMonitorStatus(status) {
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');

                // 获取当前状态
                const currentStatus = startBtn.disabled ? 'running' : 'stopped';

                // 只有状态发生变化时才更新
                if (status !== currentStatus) {
                    if (status === 'running') {
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        appendLog('监控程序已启动');
                        updateStatusBadge('running');
                    } else if (status === 'stopped') {
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                        appendLog('监控程序已停止');
                        updateStatusBadge('stopped');
                    }
                }
            }

            // 页面加载完成后更新初始状态
            document.addEventListener('DOMContentLoaded', function () {
                const initialStatus = '{{ initial_status }}';
                updateStatusBadge(initialStatus);

                // 监听模态框关闭事件，确保移除 backdrop
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('hidden.bs.modal', function () {
                        // 移除可能残留的 backdrop
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                            backdrop.remove();
                        });
                        // 恢复 body 样式
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    });
                });
            });
        </script>
</body>

</html>