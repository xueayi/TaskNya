# TaskNya 用户使用说明

> 版本: 2.0
> 更新日期: 2026-01-12

TaskNya 是一个强大的任务监控工具，可以帮助你监控训练任务、文件变化、日志输出等，并通过 Webhook (如飞书) 发送通知。

---

## 目录

- [快速开始](#快速开始)
- [基本配置](#基本配置)
- [检测方法](#检测方法)
  - [单文件感知](#单文件感知)
  - [日志检查](#日志检查)
  - [GPU 功耗检查](#gpu-功耗检查)
  - [多文件感知 (目录监控)](#多文件感知-目录监控)
- [通知设置](#通知设置)
  - [飞书机器人](#飞书机器人)
  - [通用 Webhook](#通用-webhook)
- [Linux 后台运行 (推荐)](#linux-后台运行-推荐)
- [高级功能](#高级功能)
  - [变量说明](#变量说明)
  - [操作建议配置](#操作建议配置)

---

## 快速开始

1. 启动程序：运行 `python webui.py`
2. 打开浏览器访问：`http://localhost:5000`
3. 在 Web 界面配置监控项和通知方式。
4. 点击右上角的 **应用配置** 保存并生效。
5. 可以在控制台看到监控日志。

---

## 基本配置

位于 "基本设置" 选项卡：

- **项目名称**: 给当前监控的任务起个名字，会显示在通知中。
- **检查间隔**: 每次检查循环的间隔时间（秒）。
- **日志打印间隔**: 在控制台输出 "监控中..." 的频率（秒）。
- **监控持续时间**: 设置最长监控时间，超时会自动停止。填 `None` 表示无限。

---

## 检测方法

TaskNya 支持多种检测方式，可以单独使用或组合使用。只要**任意一个**生效，就会触发通知。

### 单文件感知
监控特定文件是否存在。
- **场景**: 训练脚本运行结束后会生成一个 `result.txt` 或 `model.pth`。
- **配置**:
  - **检查文件路径**: 目标文件的绝对路径或相对路径。

### 日志检查
监控日志文件中的特定关键词。
- **场景**: 训练日志中出现 "Training completed" 或 "Error"。
- **配置**:
  - **日志文件路径**: 正在写入的日志文件。
  - **检测模式**:
    - **全量检测**: 每次都重新扫描整个文件（适合小文件）。
    - **增量检测**: 只扫描新增的内容（适合大文件，性能更好）。
  - **触发关键词**: 每行一个，只要出现任意一个即触发。

### GPU 功耗检查
监控显卡功耗是否持续低于阈值。
- **场景**: 深度学习任务结束后，GPU 功耗会显著下降。
- **配置**:
  - **检测间隔**: 检查 GPU 状态的频率。
  - **触发阈值**: 功耗（W）低于此值时计数。
  - **触发次数**: 连续 N 次低于阈值才触发通知（防止波动误报）。
  - **触发模式**: `below` (低于阈值触发) 或 `above` (高于阈值触发)。

### 多文件感知 (目录监控)
监控整个目录下的文件变化（新增、删除、修改）。
- **场景**: 监控输出目录，当有新模型生成或文件被误删时通知。
- **配置**:
  - **监控目录路径**: 要监控的文件夹路径。
  - **检测类型**:
    - **检测文件新增**: 发现新文件触发。
    - **检测文件删除**: 文件消失触发。
    - **检测文件修改**: 文件大小或时间变化触发（默认关闭）。
  - **检测文件夹变化**: 是否递归监控子文件夹。
  - **二次确认延迟**: 发现变化后等待 N 秒再次确认，确保文件写入完成。
  - **报告保存路径**: 变化详情报告的保存位置。
  - **排除关键词**: 路径中包含这些词的文件将被忽略（如 `__pycache__`）。
  - **操作建议配置**: 定义关键词对应的建议操作（详见[高级功能](#高级功能)）。

---

## 通知设置

### 飞书机器人
使用飞书群机器人发送通知。
- **配置**: 填入 Webhook URL 和密钥（可选）。

### 通用 Webhook
支持发送 HTTP POST 请求到任意地址。

#### 自定义模式
完全自定义请求体和 Header。
- **内置模板**: 提供 Discord、企业微信等预设。
- **自定义 Body**: 手写 JSON 格式的请求体。

---

## Linux 后台运行 (推荐)

在 Linux 服务器上，建议使用提供的 `manage_webui.sh` 脚本来管理 WebUI 进程，实现后台持续运行。

### 常用命令

| 命令 | 说明 |
| --- | --- |
| `./manage_webui.sh start` | 启动 WebUI (后台运行) |
| `./manage_webui.sh stop` | 停止 WebUI |
| `./manage_webui.sh restart` | 重启 WebUI |
| `./manage_webui.sh status` | 查看运行状态及最近日志 |

### 注意事项
- 脚本默认使用 `python3` 命令，并将日志输出到 `output.log`。
- 如果脚本没有执行权限，请运行 `chmod +x manage_webui.sh`。

---

## 高级功能

### 变量说明
在通知内容中可以使用 `${变量名}`，系统会自动替换：

| 变量名                 | 说明                       |
| ---------------------- | -------------------------- |
| `${project_name}`      | 项目名称                   |
| `${duration}`          | 任务耗时                   |
| `${method}`            | 触发方式（如"文件检测"）   |
| `${detail}`            | 触发详情（如文件名）       |
| `${gpu_info}`          | GPU 状态信息               |
| `${anime_quote}`       | 二次元语录                 |
| `${report_summary}`    | 目录变化摘要（如"新增 1"） |
| `${report_change_list}` | 变化文件列表             |
| `${report_actions}`    | 建议操作汇总               |

### 操作建议配置
在多文件感知中，可以根据文件名自动给出操作建议。

**配置格式**: `建议内容: 关键词1, 关键词2`

**示例**:
```
备份: important, backup
检查: error, warn, fail
发布: release, dist
```

**效果**:
- 如果新增文件名为 `model_backup.pth`，报告中会显示 `[建议: 备份]`。
- 通知变量 `${report_actions}` 会显示 `备份`。
