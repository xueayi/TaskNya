# TaskNya 用户指南

[项目主页](../README.md) | [开发手册](DEVELOPMENT.md) | [API 引用](api_reference.md)

> 版本: 2.1.0  
> 更新日期: 2026-01-15

TaskNya 是一个功能强大的任务监控工具，旨在通过多种感知方式（文件、日志、GPU、目录）实时跟踪任务进度，并在任务完成或异常时通过 Webhook 发送即时推送。

---

## 目录

- [快速开始](#快速开始)
- [核心检测方法](#核心检测方法)
  - [单文件感知](#单文件感知)
  - [日志关键字检查](#日志关键字检查)
  - [GPU 功耗/状态检查](#gpu-功耗检查)
  - [多文件 (目录) 监控](#多文件感知-目录监控)
- [通知推送配置](#通知设置)
- [Linux 服务器部署](#linux-后台运行-推荐)
- [变量与高级自定义](#高级功能)

---

## 快速开始

### 方式 A: Windows EXE 运行 (推荐)
1.  **下载**: 从 [Releases](https://github.com/xueayi/TaskNya/releases) 页面下载最新的 `TaskNya.exe`。
2.  **启动**: 直接双击运行 `TaskNya.exe`。随后会弹出一个控制台窗口，这表示 Web 服务已启动。
3.  **使用**: 按照控制台提示，在浏览器打开 `http://localhost:5000`。
4.  **关闭**: 直接关闭控制台窗口或按 `Ctrl+C` 即可停止程序。

### 方式 B: 源码运行 (Python)
1.  **启动服务**：在终端执行 `python webui.py`。
2.  **访问后台**：浏览器打开 `http://localhost:5000`。
3.  **监控任务**：在 Web 界面设置你的监控路径与触发条件。
4.  **查看进度**：通过下方的实时日志面板观察监控状态。

---

## 核心检测方法

TaskNya 支持多维度的逻辑检测，多个条件之间为“或”关系（任一触发即视为任务完成）。

### 单文件感知
- **原理**: 监控特定标志性文件（如 `model.pth` 或 `done.txt`）的生成。
- **配置**: 填写文件的绝对或相对路径。

### 日志关键字检查
- **检测模式**: 
    - **全量**: 每次扫描整份日志，适合快速运行的任务。
    - **增量**: 仅扫描自上次检查以来新增的字符，效率极高。
- **配置**: 填写路径并输入触发词列表（如 `Success`, `Error`, `Finished`）。

### GPU 功耗检查
- **场景**: 深度学习训练结束时，GPU 负载显著降低。
- **逻辑**: 当 GPU 功耗连续 $N$ 次低于阈值 $W$ 时触发通知。
- **配置**: 设置阈值 (Watts) 和连续检测次数。

### 多文件感知 (目录监控)
- **场景**: 监控整个结果目录的变动。
- **功能**:
    - 检测新增/删除/修改。
    - 递归子文件夹。
    - **二次确认**: 发现变化后延迟 $N$ 秒再次检查，避免因文件未写完导致的误判。

---

## 通知设置

### 飞书 (Feishu)
- 填入飞书群机器人的 Webhook URL。
- 支持富文本卡片展示，包含项目名、耗时等。

### 邮件 (Email)
- **SMTP 支持**: 兼容主流邮件服务商（QQ、163、Gmail、Outlook 等）。
- **配置项**:
    - **SMTP 服务器 & 端口**: 例如 `smtp.qq.com`, 端口 `465` (SSL) 或 `587` (TLS/STARTTLS)。
    - **用户名 & 密码**: 注意，大多数服务商要求使用 **授权码/App Password** 而非普通登录密码。
    - **SSL 开关**: 建议开启以保证安全性。
- **自定义**: 可自定义邮件标题与页脚内容。

### Astrbot / 通用 Webhook
- 支持发送 JSON 格式的 POST 请求。
- **自定义 Body**: 可以使用变量（如 `${project_name}`）动态构建消息内容。
- **内置模板**: 提供 Discord、Slack 等预设。

---

## Linux 后台运行 (推荐)

在 Linux 环境下，使用 `manage_webui.sh` 脚本可以确保你在退出 SSH 登录后程序依然稳定运行。

| 命令 | 说明 |
| :--- | :--- |
| `./manage_webui.sh start` | 以后台守护进程模式启动 WebUI |
| `./manage_webui.sh stop` | 安全停止背景进程 |
| `./manage_webui.sh status` | 查看当前进程 ID 及最新日志 |

> [!NOTE]
> 如果脚本执行报错，请确保已赋予权限：`chmod +x manage_webui.sh`。

---

## 高级功能

### 内容变量说明
在通知模板或建议操作中，可使用以下动态变量：

| 变量 | 含义 |
| :--- | :--- |
| `${project_name}` | 配置中的项目名称 |
| `${duration}` | 任务总运行时间 |
| `${method}` | 触发本次通知的检测方式 |
| `${detail}` | 触发点详情（如：找到的文件名或日志行内容） |
| `${gpu_info}` | 当前所有显卡的型号与功耗快照 |

### 智能建议配置
基于目录监控，你可以定义文件名关键字对应的操作建议。例如：
- `备份: checkpoint, .pth` -> 发现模型文件时提示备份。
- `检查日志: err, warn` -> 发现异常关键字时提示检查日志。

---

*本文档由 TaskNya 团队维护。更多进阶开发需求请参考 [开发手册](DEVELOPMENT.md)*
