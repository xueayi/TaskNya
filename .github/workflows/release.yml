name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Update Version in Code
        run: python scripts/update_version.py ${{ github.ref_name }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            xueayis/tasknya:latest
            xueayis/tasknya:${{ github.ref_name }}

  build-exe:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Update Version in Code
        run: python scripts/update_version.py ${{ github.ref_name }}

      - name: Build EXE
        run: |
          pyinstaller TaskNya.spec --noconfirm
          Rename-Item -Path "dist/TaskNya.exe" -NewName "TaskNya-${{ github.ref_name }}-windows-amd64.exe"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TaskNya-Windows
          path: dist/TaskNya-${{ github.ref_name }}-windows-amd64.exe

  create-release:
    needs: [build-docker, build-exe]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download EXE Artifact
        uses: actions/download-artifact@v4
        with:
          name: TaskNya-Windows
          path: ./release

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./release/TaskNya-*.exe
          name: Release ${{ github.ref_name }}
          body: |
            ## TaskNya ${{ github.ref_name }} 发布记录
            
            感谢使用 TaskNya！本次发布包含了自动构建的 Docker 镜像和 Windows 可执行文件。
            
            ### 产物说明
            - **Docker**: `docker pull xueayis/tasknya:latest` 或 `xueayis/tasknya:${{ github.ref_name }}`
            - **Windows**: 下载下方的 `.exe` 文件即可运行。
            
            ### 更新日志
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
